<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector V4 Integration Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üß™ Collector ‚Üî API V4 Integration Test</h1>
        
        <!-- API Status -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">API Status</h2>
            <div id="api-status" class="text-gray-600">Checking...</div>
        </div>

        <!-- Authentication -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Authentication</h2>
            <div class="space-y-4">
                <div>
                    <button id="btn-login" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Login (test/test123)
                    </button>
                    <button id="btn-logout" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 ml-2">
                        Logout
                    </button>
                </div>
                <div id="auth-status" class="text-sm text-gray-600"></div>
            </div>
        </div>

        <!-- Entity Operations -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Entity Operations</h2>
            <div class="space-y-4">
                <div>
                    <button id="btn-create-entity" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Create Test Entity
                    </button>
                    <button id="btn-list-entities" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 ml-2">
                        List Entities
                    </button>
                </div>
                <div id="entity-result" class="text-sm bg-gray-50 p-4 rounded font-mono overflow-auto max-h-64"></div>
            </div>
        </div>

        <!-- Curation Operations -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Curation Operations</h2>
            <div class="space-y-4">
                <div>
                    <input id="input-entity-id" type="text" placeholder="Entity ID" 
                           class="border border-gray-300 px-3 py-2 rounded mr-2">
                    <button id="btn-create-curation" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Create Test Curation
                    </button>
                    <button id="btn-list-curations" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 ml-2">
                        List Curations
                    </button>
                </div>
                <div id="curation-result" class="text-sm bg-gray-50 p-4 rounded font-mono overflow-auto max-h-64"></div>
            </div>
        </div>

        <!-- Console -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Console Log</h2>
            <div id="console" class="text-xs bg-black text-green-400 p-4 rounded font-mono overflow-auto max-h-96"></div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script src="scripts/config.js"></script>
    <script src="scripts/logger.js"></script>
    <script src="scripts/moduleWrapper.js"></script>
    <script src="scripts/apiService.js"></script>
    <script src="scripts/syncAdapterV4.js"></script>
    <script src="scripts/apiServiceV4Extensions.js"></script>

    <script>
        // Console logger
        const consoleDiv = document.getElementById('console');
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            consoleDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }

        // API Status Check
        async function checkApiStatus() {
            try {
                const response = await fetch('http://localhost:8001/health');
                const data = await response.json();
                document.getElementById('api-status').innerHTML = 
                    `<span class="text-green-600">‚úÖ ${data.status}</span> - Version: ${data.version} - Database: ${data.database}`;
                log('API is healthy', 'success');
                return true;
            } catch (error) {
                document.getElementById('api-status').innerHTML = 
                    `<span class="text-red-600">‚ùå Offline</span> - ${error.message}`;
                log(`API check failed: ${error.message}`, 'error');
                return false;
            }
        }

        // Wait for all dependencies to load
        function waitForDependencies() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100; // 5 seconds max
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (window.AppConfig && window.Logger && window.ModuleWrapper && window.ApiService) {
                        clearInterval(checkInterval);
                        log('All dependencies loaded', 'success');
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        log('Timeout waiting for dependencies', 'error');
                        log(`Missing: ${!window.AppConfig ? 'AppConfig ' : ''}${!window.Logger ? 'Logger ' : ''}${!window.ModuleWrapper ? 'ModuleWrapper ' : ''}${!window.ApiService ? 'ApiService' : ''}`, 'error');
                        resolve(false);
                    }
                }, 50);
            });
        }

        // Initialize
        async function init() {
            log('üöÄ Starting Collector V4 Integration Test...');
            
            // Wait for dependencies
            const depsLoaded = await waitForDependencies();
            if (!depsLoaded) {
                log('‚ùå Failed to load dependencies. Cannot continue.', 'error');
                return;
            }
            
            // Check API
            const apiOk = await checkApiStatus();
            if (!apiOk) {
                log('‚ö†Ô∏è API is not responding. Start it with: cd concierge-api-v4 && ./start_api.sh', 'error');
            }
            
            // Initialize ApiService
            try {
                log('Initializing ApiService...');
                await window.ApiService.initialize();
                log('‚úÖ ApiService initialized', 'success');
            } catch (error) {
                log(`‚ùå ApiService initialization failed: ${error.message}`, 'error');
            }

            // Check auth status
            updateAuthStatus();
            log('üéØ Ready for testing!', 'success');
        }

        function updateAuthStatus() {
            const isAuth = window.ApiService.isAuthenticated();
            const token = window.ApiService.getAuthToken();
            document.getElementById('auth-status').innerHTML = isAuth 
                ? `<span class="text-green-600">‚úÖ Authenticated</span> - Token: ${token ? token.substring(0, 50) + '...' : 'N/A'}`
                : '<span class="text-red-600">‚ùå Not authenticated</span>';
        }

        // Event Listeners
        document.getElementById('btn-login').addEventListener('click', async () => {
            try {
                log('Attempting login...');
                const token = await window.ApiService.login('test', 'test123');
                log(`Login successful! Token: ${token.substring(0, 50)}...`, 'success');
                updateAuthStatus();
            } catch (error) {
                log(`Login failed: ${error.message}`, 'error');
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            window.ApiService.logout();
            log('Logged out', 'success');
            updateAuthStatus();
        });

        document.getElementById('btn-create-entity').addEventListener('click', async () => {
            try {
                if (!window.ApiService.isAuthenticated()) {
                    log('Please login first!', 'error');
                    return;
                }

                log('Creating test entity...');
                const entityData = {
                    name: `Test Restaurant ${Date.now()}`,
                    type: 'restaurant',
                    status: 'active',
                    location: {
                        address: '123 Test St',
                        city: 'Test City',
                        country: 'Test Country'
                    },
                    contact: {
                        phone: '+1234567890',
                        email: 'test@test.com'
                    },
                    tags: ['test'],
                    createdBy: 'test'
                };

                const result = await window.ApiService.createEntityV4(entityData);
                document.getElementById('entity-result').textContent = JSON.stringify(result, null, 2);
                log(`Entity created: ${result.entity_id}`, 'success');
            } catch (error) {
                log(`Create entity failed: ${error.message}`, 'error');
                document.getElementById('entity-result').textContent = error.message;
            }
        });

        document.getElementById('btn-list-entities').addEventListener('click', async () => {
            try {
                log('Fetching entities...');
                const result = await window.ApiService.getEntitiesV4({ limit: 10 });
                document.getElementById('entity-result').textContent = JSON.stringify(result, null, 2);
                
                if (result && result.entities) {
                    log(`Fetched ${result.entities.length} entities`, 'success');
                } else {
                    log(`Unexpected result format: ${JSON.stringify(result)}`, 'error');
                }
            } catch (error) {
                log(`List entities failed: ${error.message}`, 'error');
                document.getElementById('entity-result').textContent = error.message;
            }
        });

        document.getElementById('btn-create-curation').addEventListener('click', async () => {
            try {
                if (!window.ApiService.isAuthenticated()) {
                    log('Please login first!', 'error');
                    return;
                }

                const entityId = document.getElementById('input-entity-id').value;
                if (!entityId) {
                    log('Please enter an entity ID!', 'error');
                    return;
                }

                log('Creating test curation...');
                const curationData = {
                    entity_id: entityId,
                    curator_id: 'test',
                    category: 'review',
                    concept: 'Test curation concept',
                    notes: 'Created from integration test',
                    tags: ['test']
                };

                const result = await window.ApiService.createCurationV4(curationData);
                document.getElementById('curation-result').textContent = JSON.stringify(result, null, 2);
                log(`Curation created: ${result.curation_id}`, 'success');
            } catch (error) {
                log(`Create curation failed: ${error.message}`, 'error');
                document.getElementById('curation-result').textContent = error.message;
            }
        });

        document.getElementById('btn-list-curations').addEventListener('click', async () => {
            try {
                log('Fetching curations...');
                const result = await window.ApiService.getCurationsV4({ limit: 10 });
                document.getElementById('curation-result').textContent = JSON.stringify(result, null, 2);
                
                if (result && result.curations) {
                    log(`Fetched ${result.curations.length} curations`, 'success');
                } else {
                    log(`Unexpected result format: ${JSON.stringify(result)}`, 'error');
                }
            } catch (error) {
                log(`List curations failed: ${error.message}`, 'error');
                document.getElementById('curation-result').textContent = error.message;
            }
        });

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            try {
                init();
            } catch (error) {
                console.error('Initialization error:', error);
                log(`Initialization failed: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
