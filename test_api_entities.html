<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Entities Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
        }
        .result {
            margin-top: 10px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #4CAF50;
            background: #e8f5e9;
        }
        .error {
            border-left: 4px solid #f44336;
            background: #ffebee;
        }
        .warning {
            border-left: 4px solid #ff9800;
            background: #fff3e0;
        }
        .info {
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            margin: 15px 0;
            border-radius: 4px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #4CAF50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.pending { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß API Entities Migration Test</h1>
        
        <div class="info">
            <strong>‚úÖ Migration Complete:</strong> All endpoints now use <code>/api/entities</code> instead of <code>/api/restaurants</code>
            <br><br>
            <strong>Backend URL:</strong> <span id="backend-url"></span>
        </div>

        <h2>1. Health Check</h2>
        <div class="test-section">
            <button onclick="testHealth()">Test /api/health</button>
            <button onclick="testInfo()">Test /api/info</button>
            <div id="health-result" class="result" style="display: none;"></div>
        </div>

        <h2>2. Restaurant Operations (via /api/entities)</h2>
        <div class="test-section">
            <button onclick="testGetRestaurants()">GET All Restaurants</button>
            <button onclick="testGetSingleRestaurant()">GET Single Restaurant</button>
            <div id="get-result" class="result" style="display: none;"></div>
        </div>

        <h2>3. Create Restaurant</h2>
        <div class="test-section">
            <button onclick="testCreateRestaurant()">POST Create Restaurant</button>
            <div id="create-result" class="result" style="display: none;"></div>
        </div>

        <h2>4. Format Transformation Test</h2>
        <div class="test-section">
            <p>Test V2 export format ‚Üí Entity format transformation:</p>
            <button onclick="testV2Transformation()">Test V2 Format Transformation</button>
            <div id="transform-result" class="result" style="display: none;"></div>
        </div>

        <h2>5. Bulk Import</h2>
        <div class="test-section">
            <button onclick="testBulkImport()">POST Bulk Import (via /api/import/concierge-v2)</button>
            <button onclick="testBulkImportV2()">POST Bulk Import (V2 Format)</button>
            <div id="bulk-result" class="result" style="display: none;"></div>
        </div>

        <h2>6. Legacy Endpoints (Should Fail)</h2>
        <div class="test-section">
            <p class="warning">‚ö†Ô∏è These should return 404/405 errors since they don't exist on MySQL backend:</p>
            <button onclick="testLegacyRestaurants()">Test /api/restaurants</button>
            <button onclick="testLegacyBatch()">Test /api/restaurants/batch</button>
            <div id="legacy-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="scripts/moduleWrapper.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/apiService.js"></script>

    <script>
        // Display backend URL
        document.getElementById('backend-url').textContent = window.AppConfig.api.backend.baseUrl;

        function displayResult(elementId, result, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            
            if (typeof result === 'object') {
                element.textContent = JSON.stringify(result, null, 2);
            } else {
                element.textContent = result;
            }
        }

        async function testHealth() {
            try {
                const response = await window.apiService.get('/health');
                displayResult('health-result', response, response.success ? 'success' : 'error');
            } catch (error) {
                displayResult('health-result', { error: error.message }, 'error');
            }
        }

        async function testInfo() {
            try {
                const response = await window.apiService.get('/info');
                displayResult('health-result', response, response.success ? 'success' : 'error');
            } catch (error) {
                displayResult('health-result', { error: error.message }, 'error');
            }
        }

        async function testGetRestaurants() {
            try {
                console.log('Testing GET /api/entities?entity_type=restaurant');
                const response = await window.apiService.getRestaurants();
                
                displayResult('get-result', {
                    endpoint: '/api/entities?entity_type=restaurant',
                    success: response.success,
                    count: Array.isArray(response.data) ? response.data.length : 0,
                    data: response.data,
                    error: response.error
                }, response.success ? 'success' : 'error');
            } catch (error) {
                displayResult('get-result', { error: error.message }, 'error');
            }
        }

        async function testGetSingleRestaurant() {
            try {
                // First get all restaurants to find an ID
                const listResponse = await window.apiService.getRestaurants();
                
                if (!listResponse.success || !Array.isArray(listResponse.data) || listResponse.data.length === 0) {
                    displayResult('get-result', {
                        error: 'No restaurants available to test single GET'
                    }, 'warning');
                    return;
                }
                
                const firstRestaurantId = listResponse.data[0].id;
                console.log(`Testing GET /api/entities/${firstRestaurantId}`);
                
                const response = await window.apiService.getRestaurant(firstRestaurantId);
                
                displayResult('get-result', {
                    endpoint: `/api/entities/${firstRestaurantId}`,
                    success: response.success,
                    data: response.data,
                    error: response.error
                }, response.success ? 'success' : 'error');
            } catch (error) {
                displayResult('get-result', { error: error.message }, 'error');
            }
        }

        async function testCreateRestaurant() {
            try {
                const testRestaurant = {
                    name: `Test Restaurant ${Date.now()}`,
                    description: 'Created via API entities migration test',
                    transcription: 'This is a test restaurant',
                    location: {
                        latitude: 40.7128,
                        longitude: -74.0060,
                        address: 'New York, NY'
                    },
                    notes: {
                        private: 'Private test note',
                        public: 'Public test note'
                    },
                    concepts: [
                        { category: 'Cuisine', value: 'Italian' },
                        { category: 'Price', value: '$$' }
                    ],
                    curatorId: 1,
                    curatorName: 'Test Curator'
                };

                console.log('Testing POST /api/entities with restaurant data');
                const response = await window.apiService.createRestaurant(testRestaurant);
                
                displayResult('create-result', {
                    endpoint: '/api/entities',
                    method: 'POST',
                    success: response.success,
                    data: response.data,
                    error: response.error
                }, response.success ? 'success' : 'error');
            } catch (error) {
                displayResult('create-result', { error: error.message }, 'error');
            }
        }

        async function testV2Transformation() {
            try {
                // Create a sample V2 format restaurant (as exported by exportDataV2)
                const v2Restaurant = {
                    metadata: [
                        {
                            type: 'restaurant',
                            id: 999,
                            serverId: 123,
                            created: {
                                timestamp: '2025-10-20T12:00:00.000Z',
                                curator: {
                                    id: 1,
                                    name: 'Test Curator'
                                }
                            },
                            sync: {
                                status: 'synced',
                                lastSyncedAt: '2025-10-20T13:00:00.000Z'
                            }
                        },
                        {
                            type: 'collector',
                            source: 'local',
                            data: {
                                name: 'V2 Format Test Restaurant',
                                description: 'Testing V2 to Entity transformation',
                                transcription: 'Test transcription',
                                location: {
                                    latitude: 40.7128,
                                    longitude: -74.0060,
                                    address: 'New York, NY'
                                },
                                photos: [
                                    {
                                        id: 1,
                                        photoData: 'data:image/jpeg;base64,test',
                                        timestamp: '2025-10-20T12:00:00.000Z'
                                    }
                                ]
                            }
                        }
                    ],
                    'Cuisine': ['Italian', 'Pizza'],
                    'Price Range': ['$$'],
                    'Mood': ['Casual', 'Cozy']
                };

                console.log('Testing V2 format transformation...');
                const flatFormat = window.apiService.transformV2ToFlatFormat(v2Restaurant);
                
                displayResult('transform-result', {
                    test: 'V2 ‚Üí Flat Format Transformation',
                    input: 'V2 format with metadata array',
                    output: 'Flat format compatible with entity creation',
                    inputSample: {
                        hasMetadata: true,
                        metadataTypes: v2Restaurant.metadata.map(m => m.type),
                        rootCategories: Object.keys(v2Restaurant).filter(k => k !== 'metadata')
                    },
                    outputSample: {
                        name: flatFormat.name,
                        description: flatFormat.description,
                        conceptsCount: flatFormat.concepts?.length || 0,
                        photosCount: flatFormat.photos?.length || 0,
                        hasLocation: !!flatFormat.location,
                        curatorId: flatFormat.curatorId,
                        curatorName: flatFormat.curatorName
                    },
                    fullOutput: flatFormat
                }, 'success');
            } catch (error) {
                displayResult('transform-result', { error: error.message }, 'error');
            }
        }

        async function testBulkImport() {
            try {
                const testRestaurants = [
                    {
                        name: `Bulk Test 1 ${Date.now()}`,
                        description: 'Bulk import test restaurant 1',
                        concepts: [
                            { category: 'Cuisine', value: 'Italian' },
                            { category: 'Price Range', value: '$$' }
                        ],
                        curatorId: 1,
                        curatorName: 'Test Curator'
                    },
                    {
                        name: `Bulk Test 2 ${Date.now()}`,
                        description: 'Bulk import test restaurant 2',
                        concepts: [
                            { category: 'Cuisine', value: 'French' }
                        ],
                        curatorId: 1,
                        curatorName: 'Test Curator'
                    }
                ];

                console.log('Testing POST /api/import/concierge-v2 with flat format data');
                const response = await window.apiService.batchUploadRestaurants(testRestaurants);
                
                displayResult('bulk-result', {
                    endpoint: '/api/import/concierge-v2',
                    method: 'POST',
                    format: 'Flat format',
                    success: response.success,
                    data: response.data,
                    error: response.error
                }, response.success ? 'success' : 'error');
            } catch (error) {
                displayResult('bulk-result', { error: error.message }, 'error');
            }
        }

        async function testBulkImportV2() {
            try {
                // Create sample restaurants in V2 format
                const v2Restaurants = [
                    {
                        metadata: [
                            {
                                type: 'restaurant',
                                id: 1001,
                                created: {
                                    timestamp: new Date().toISOString(),
                                    curator: {
                                        id: 1,
                                        name: 'Test Curator'
                                    }
                                }
                            },
                            {
                                type: 'collector',
                                source: 'local',
                                data: {
                                    name: `V2 Bulk Test 1 ${Date.now()}`,
                                    description: 'V2 format bulk import test'
                                }
                            }
                        ],
                        'Cuisine': ['Japanese'],
                        'Price Range': ['$$$']
                    },
                    {
                        metadata: [
                            {
                                type: 'restaurant',
                                id: 1002,
                                created: {
                                    timestamp: new Date().toISOString(),
                                    curator: {
                                        id: 1,
                                        name: 'Test Curator'
                                    }
                                }
                            },
                            {
                                type: 'collector',
                                source: 'local',
                                data: {
                                    name: `V2 Bulk Test 2 ${Date.now()}`,
                                    description: 'V2 format bulk import test 2'
                                }
                            }
                        ],
                        'Cuisine': ['Mexican'],
                        'Mood': ['Lively']
                    }
                ];

                console.log('Testing POST /api/import/concierge-v2 with V2 format data');
                const response = await window.apiService.batchUploadRestaurants(v2Restaurants);
                
                displayResult('bulk-result', {
                    endpoint: '/api/import/concierge-v2',
                    method: 'POST',
                    format: 'V2 format (with transformation)',
                    restaurantsCount: v2Restaurants.length,
                    success: response.success,
                    data: response.data,
                    error: response.error
                }, response.success ? 'success' : 'error');
            } catch (error) {
                displayResult('bulk-result', { error: error.message }, 'error');
            }
        }

        async function testLegacyRestaurants() {
            try {
                console.log('Testing legacy GET /api/restaurants (should fail)');
                const response = await window.apiService.get('/restaurants');
                
                displayResult('legacy-result', {
                    endpoint: '/api/restaurants',
                    expected: '404 or 405 error',
                    actual: response,
                    note: response.success ? 'UNEXPECTED: This endpoint should not exist!' : 'EXPECTED: Endpoint does not exist'
                }, response.success ? 'error' : 'success');
            } catch (error) {
                displayResult('legacy-result', {
                    endpoint: '/api/restaurants',
                    expected: 'Error (endpoint does not exist)',
                    actual: error.message,
                    note: 'EXPECTED: This is the correct behavior'
                }, 'success');
            }
        }

        async function testLegacyBatch() {
            try {
                console.log('Testing legacy POST /api/restaurants/batch (should fail)');
                const response = await window.apiService.post('/restaurants/batch', []);
                
                displayResult('legacy-result', {
                    endpoint: '/api/restaurants/batch',
                    expected: '404 or 405 error',
                    actual: response,
                    note: response.success ? 'UNEXPECTED: This endpoint should not exist!' : 'EXPECTED: Endpoint does not exist'
                }, response.success ? 'error' : 'success');
            } catch (error) {
                displayResult('legacy-result', {
                    endpoint: '/api/restaurants/batch',
                    expected: 'Error (endpoint does not exist)',
                    actual: error.message,
                    note: 'EXPECTED: This is the correct behavior'
                }, 'success');
            }
        }

        // Auto-run health check on load
        window.addEventListener('load', () => {
            console.log('üîß API Entities Migration Test Page Loaded');
            console.log('Backend URL:', window.AppConfig.api.backend.baseUrl);
            testHealth();
        });
    </script>
</body>
</html>
