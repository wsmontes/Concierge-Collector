# Backend Tests - CI/CD Pipeline
# Runs Python/FastAPI tests on push and pull requests

name: Backend Tests

on:
  push:
    branches: [ main, Front-End-V3, develop ]
  pull_request:
    branches: [ main, Front-End-V3 ]

jobs:
  test:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    
    env:
      MONGODB_URL: ${{ secrets.MONGODB_URL }}
      GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
      API_SECRET_KEY: ${{ secrets.API_SECRET_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
      GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./concierge-api-v3
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run pytest (unit tests only)
        working-directory: ./concierge-api-v3
        run: |
          pytest tests/ -v --tb=short -m "not integration and not external_api and not mongo and not openai" --maxfail=5
      
      - name: Run pytest with coverage (unit tests only)
        working-directory: ./concierge-api-v3
        run: |
          pip install pytest-cov
          pytest tests/ -m "not integration and not external_api and not mongo and not openai" --cov=app --cov-report=xml --cov-report=term
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage-report
          path: concierge-api-v3/coverage.xml
          retention-days: 30
      
      - name: Test Summary
        if: always()
        run: |
          echo "## ✅ Backend Tests Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Python version: 3.12" >> $GITHUB_STEP_SUMMARY
          echo "- Tests location: concierge-api-v3/tests/" >> $GITHUB_STEP_SUMMARY
          echo "- Framework: pytest + FastAPI TestClient" >> $GITHUB_STEP_SUMMARY

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install linting tools
        run: |
          pip install flake8 black
      
      - name: Run Black formatter check
        working-directory: ./concierge-api-v3
        run: |
          black --check app/ tests/ || echo "⚠️ Code formatting issues found (non-blocking)"
      
      - name: Run Flake8 linter
        working-directory: ./concierge-api-v3
        run: |
          flake8 app/ tests/ --max-line-length=120 --ignore=E203,W503 || echo "⚠️ Linting issues found (non-blocking)"
