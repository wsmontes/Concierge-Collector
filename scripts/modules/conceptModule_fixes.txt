/**
 * Module: ConceptModule  
 * Purpose: Handle restaurant concept extraction and management
 * Dependencies: ApiService, AuthService, SafetyUtils, uiManager
 *
 * This file contains simplified extraction methods to avoid conflicts
 */

/**
 * Reprocess concepts from edited transcription (manual button click)
 * This is the ONLY entry point for manual reprocessing
 */
async reprocessConcepts() {
    this.log.debug('Manual reprocess initiated');
    const transcriptionTextarea = document.getElementById('restaurant-transcription');
    const transcription = transcriptionTextarea ? transcriptionTextarea.value.trim() : '';
    
    if (!transcription) {
        SafetyUtils.showNotification('Please provide a transcription first', 'error');
        return;
    }
    
    try {
        SafetyUtils.showLoading('Analyzing restaurant details...');
        
        // Call API to extract concepts
        const result = await window.ApiService.extractConcepts(transcription, 'restaurant');
        
        // Extract concepts from API response
        let conceptsData = null;
        if (result.results && result.results.concepts && result.results.concepts.concepts) {
            conceptsData = result.results.concepts.concepts;
        } else if (result.concepts && result.concepts.concepts) {
            conceptsData = result.concepts.concepts;
        } else if (result.concepts) {
            conceptsData = result.concepts;
        }
        
        console.log('REPROCESS - Extracted concepts:', conceptsData);
        
        if (conceptsData && Object.keys(conceptsData).length > 0) {
            // Process using the standard validation method
            await this.handleExtractedConceptsWithValidation(conceptsData, transcription);
        } else {
            this.uiManager.currentConcepts = [];
            this.renderConcepts();
            SafetyUtils.showNotification('No concepts extracted', 'warning');
        }
        
        // Generate description
        await this.generateDescription(transcription);
        
        SafetyUtils.hideLoading();
        SafetyUtils.showNotification('Concepts and description updated successfully');
    } catch (error) {
        SafetyUtils.hideLoading();
        this.log.error('Error reprocessing concepts:', error);
        SafetyUtils.showNotification('Error processing restaurant details', 'error');
    }
}

/**
 * Process pre-extracted concepts from orchestrate API (avoids redundant API call)
 * This is called ONLY when orchestrate endpoint returns concepts with the transcription
 * @param {string} transcriptionText - The transcription text
 * @param {object} preExtractedConcepts - Concepts already extracted by orchestrate endpoint
 */
async processPreExtractedConcepts(transcriptionText, preExtractedConcepts) {
    try {
        console.log('=== PRE-EXTRACTED CONCEPTS START ===');
        console.log('Transcription:', transcriptionText);
        console.log('Raw concepts:', preExtractedConcepts);
        
        SafetyUtils.showLoading('Processing concepts...');
        this.uiManager.showConceptsSection();
        
        // Extract concepts dict (handle nested structure)
        let conceptsData = preExtractedConcepts.concepts || preExtractedConcepts;
        console.log('Concepts data to process:', conceptsData);
        
        // Process if valid format: {category: [values]}
        if (conceptsData && typeof conceptsData === 'object' && !Array.isArray(conceptsData)) {
            await this.handleExtractedConceptsWithValidation(conceptsData, transcriptionText);
            await this.generateDescription(transcriptionText);
            console.log('=== PRE-EXTRACTED CONCEPTS COMPLETE ===');
        } else {
            console.error('Invalid concepts format:', conceptsData);
            SafetyUtils.showNotification('Invalid concepts format', 'error');
        }
        
        SafetyUtils.hideLoading();
        
    } catch (error) {
        SafetyUtils.hideLoading();
        this.log.error('Error processing pre-extracted concepts:', error);
        SafetyUtils.showNotification('Error processing concepts', 'error');
    }
}

// Remove extractConcepts() entirely - it's causing confusion
// reprocessConcepts should call ApiService directly
// processPreExtractedConcepts should just process what it receives
