<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataStore Fresh Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .log { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
    </style>
    
    <!-- Load required dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/logger.js"></script>
    <script src="scripts/dataStore.js"></script>
</head>
<body>
    <h1>üß™ DataStore Fresh Test</h1>
    <div id="results"></div>
    
    <script>
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = `log ${type}`;
            logElement.textContent = `[${timestamp}] ${message}`;
            document.getElementById('results').appendChild(logElement);
            console.log(`[${timestamp}] ${message}`);
            
            logElement.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function testDataStoreFresh() {
            try {
                addLog('üöÄ Starting fresh DataStore test...', 'info');
                
                // Test 1: Check if DataStore is loaded
                if (!window.DataStore) {
                    throw new Error('DataStore not available');
                }
                addLog('‚úÖ DataStore class found', 'success');
                
                // Test 2: Initialize with fresh instance
                addLog('üîÑ Initializing fresh DataStore instance...', 'info');
                
                // Create a completely new instance to avoid any caching issues
                const freshDataStore = Object.create(window.DataStore);
                
                await freshDataStore.initialize();
                
                if (!freshDataStore.isInitialized) {
                    throw new Error('Fresh DataStore failed to initialize');
                }
                addLog('‚úÖ Fresh DataStore initialized successfully', 'success');
                
                // Test 3: Verify database is working
                addLog('üîÑ Testing database operations...', 'info');
                
                if (!freshDataStore.db || !freshDataStore.db.isOpen()) {
                    throw new Error('Database not properly opened');
                }
                
                // Test basic table access
                const entityCount = await freshDataStore.db.entities.count();
                addLog(`‚úÖ Entities table accessible: ${entityCount} records`, 'success');
                
                const curatorCount = await freshDataStore.db.curators.count();
                addLog(`‚úÖ Curators table accessible: ${curatorCount} records`, 'success');
                
                const syncQueueCount = await freshDataStore.db.syncQueue.count();
                addLog(`‚úÖ SyncQueue table accessible: ${syncQueueCount} records`, 'success');
                
                // Test 4: Test DataStore methods
                addLog('üîÑ Testing DataStore methods...', 'info');
                
                const pendingItems = await freshDataStore.getPendingSyncItems();
                addLog(`‚úÖ getPendingSyncItems: ${pendingItems.length} items`, 'success');
                
                const currentCurator = await freshDataStore.getCurrentCurator();
                addLog(`‚úÖ getCurrentCurator: ${currentCurator ? currentCurator.name : 'null'}`, 'success');
                
                // Test 5: Create test entity
                addLog('üîÑ Testing entity creation...', 'info');
                
                const testEntity = await freshDataStore.createEntity({
                    type: 'restaurant',
                    name: 'Fresh Test Restaurant',
                    data: {
                        cuisine: ['Test'],
                        location: 'Fresh Test Location'
                    }
                });
                addLog(`‚úÖ Created entity: ${testEntity.entity_id}`, 'success');
                
                // Test 6: Verify entity was saved
                const retrievedEntity = await freshDataStore.getEntity(testEntity.entity_id);
                if (!retrievedEntity) {
                    throw new Error('Failed to retrieve created entity');
                }
                addLog(`‚úÖ Retrieved entity: ${retrievedEntity.name}`, 'success');
                
                addLog('üéâ All DataStore tests passed!', 'success');
                
            } catch (error) {
                addLog(`‚ùå Test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        // Run test when page loads
        window.addEventListener('DOMContentLoaded', testDataStoreFresh);
    </script>
</body>
</html>