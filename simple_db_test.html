<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Database Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .log { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
    </style>
    
    <!-- Load Dexie -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>
    
    <!-- Load Config and Logger -->
    <script src="scripts/config.js"></script>
    <script src="scripts/logger.js"></script>
    
    <!-- Load DataStore -->
    <script src="scripts/dataStore.js"></script>
</head>
<body>
    <h1>üß™ Simple Database Test</h1>
    <div id="results"></div>
    
    <script>
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = `log ${type}`;
            logElement.textContent = `[${timestamp}] ${message}`;
            document.getElementById('results').appendChild(logElement);
            console.log(`[${timestamp}] ${message}`);
            
            // Auto-scroll to latest log
            logElement.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function simpleTest() {
            try {
                addLog('üöÄ Starting simple database test...', 'info');
                
                // Create a fresh database manually
                addLog('üóëÔ∏è Cleaning up old databases...', 'info');
                
                const legacyDbs = [
                    'RestaurantCurator',
                    'RestaurantCuratorV2', 
                    'ConciergeCollectorV2',
                    'ConciergeCollectorV3',
                    'ConciergeCollectorV3_V3',
                    'ConciergeCollectorV3_Clean'
                ];
                
                for (const dbName of legacyDbs) {
                    try {
                        await Dexie.delete(dbName);
                        addLog(`üóëÔ∏è Deleted: ${dbName}`, 'info');
                    } catch (error) {
                        // Ignore - database might not exist
                    }
                }
                
                addLog('üîß Creating new clean database...', 'info');
                
                const db = new Dexie('TestDB_Clean');
                db.version(1).stores({
                    entities: '++id, entity_id, type, name, status, createdAt',
                    curations: '++id, curation_id, entity_id, curator_id, concept, createdAt',
                    curators: '++id, curator_id, name, email, status, createdAt',
                    syncQueue: '++id, type, action, local_id, entity_id, createdAt',
                    settings: 'key',
                    cache: 'key, expires'
                });
                
                await db.open();
                addLog('‚úÖ Database created and opened successfully', 'success');
                
                // Test table access
                addLog('üìä Testing table access...', 'info');
                
                const entitiesCount = await db.entities.count();
                addLog(`‚úÖ Entities table: ${entitiesCount} records`, 'success');
                
                const curatorsCount = await db.curators.count();
                addLog(`‚úÖ Curators table: ${curatorsCount} records`, 'success');
                
                const syncCount = await db.syncQueue.count();
                addLog(`‚úÖ SyncQueue table: ${syncCount} records`, 'success');
                
                // Test adding data
                addLog('üìù Testing data operations...', 'info');
                
                const curatorId = await db.curators.add({
                    curator_id: 'test_curator',
                    name: 'Test Curator',
                    email: 'test@example.com',
                    status: 'active',
                    createdAt: new Date()
                });
                addLog(`‚úÖ Added curator with ID: ${curatorId}`, 'success');
                
                const entityId = await db.entities.add({
                    entity_id: 'test_restaurant_001',
                    type: 'restaurant',
                    name: 'Test Restaurant',
                    status: 'active',
                    createdAt: new Date()
                });
                addLog(`‚úÖ Added entity with ID: ${entityId}`, 'success');
                
                // Test querying
                const curator = await db.curators.where('curator_id').equals('test_curator').first();
                addLog(`‚úÖ Retrieved curator: ${curator.name}`, 'success');
                
                const entity = await db.entities.where('entity_id').equals('test_restaurant_001').first();
                addLog(`‚úÖ Retrieved entity: ${entity.name}`, 'success');
                
                addLog('üéâ All database operations successful!', 'success');
                
                // Cleanup
                await db.close();
                await Dexie.delete('TestDB_Clean');
                addLog('üßπ Test cleanup completed', 'info');
                
            } catch (error) {
                addLog(`‚ùå Test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        // Run test when page loads
        window.addEventListener('DOMContentLoaded', simpleTest);
    </script>
</body>
</html>